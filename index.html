<html lang="en">
  <head>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="./bitcoinjs-1-0-0.js"></script>
<script src="./sjcl-bip39.js"></script>
<script src="./wordlist_english.js"></script>
<script src="./jsbip39.js"></script>
<script>
// this is really quickly hacked together => not really a nice JS code
doubles = ["ae",
"ro",
"is",
"tn",
"lc",
"up",
"dm",
"bg",
"hf",
"wv",
"ky",
"xj",
"zq",
"_"]
reverse = []
splitDoubles = [];
doubles.forEach(function(d,i){
    reverse[d]=i+1;
    d.split("").forEach(function(s) {
        splitDoubles[s]=d;
    })
})

if (window.location.hash) {
    var hash = window.location.hash.substring(1); //Puts hash in variable, and removes the # character

    $(document).ready(function() { 
        hash.split(",").forEach(function(n, i) {
            elem = $("#count"+(i+1));
            elem.val(n);
        })
        onNuChange();
    });
} else {

    $(document).ready(function() { 
        inputs().forEach(function(e){
            e.value = "10";
            onNuChange();
        })
    });
}

function inputs() {
    var nodeList = document.querySelectorAll('#letter-form input'),
        nodeArray = [].slice.call(nodeList);
   return nodeArray;
}

function countsLegal() {
    return !(inputs().some(function(e){
        if (e.value === "") {
            return true;
        }
        if (isNaN(e.value)) {
            return true;
        }
        if (e.value < 0) {
            return true;
        }
        return false;
    }));
}

function hashString() {
    if (!countsLegal()){
        return "";
    }
    return inputs().map(function(e){return e.value}).join(",");
}

function getCountObject() {
    var res = {};
    inputs().forEach(function(e,i) {
        var letter = doubles[i];
        var nu = +(e.value);
        res[letter]=nu;
    })
    return res;
}

var lastCount;

function onNuChange(noRunJson) {
    window.location.hash="#"+hashString();
    if (countsLegal()) {
        var countObject = getCountObject();
        if (JSON.stringify(countObject) === lastCount) {
            return;
        }
        lastCount = JSON.stringify(countObject);
        evaluateAll();
        repaintWords();
        //hack, too lazy
        if (noRunJson!==true){
            $("#json").val(JSON.stringify(countObject));
        }
        var link="http://karelbilek.com/seedcount/#"+hashString();
        $("#link").html('<a href="'+link+'">'+link+'</a>');
        sum = 0;
        doubles.forEach(function(d){
            sum += countObject[d];
        });
        $("#totcards").text(sum);
    }
}

function onJsonChange() {
    var json = $("#json").val().split("'").join('"');
    var obj = JSON.parse(json);
    Object.keys(obj).forEach(function(lett) {
        var nu = reverse[lett];
        $("#count"+nu).val(obj[lett]);
    })
    onNuChange(true);
}

$(document).ready(function() { 
    inputs().forEach(function(e){
        $(e).bind("propertychange change click keyup input paste", onNuChange) 
    });
    $("#json").bind("propertychange change click keyup input paste", onJsonChange) 

})
var mnemonic = new Mnemonic("english");
var strength = 24 / 3 * 32;

var allWords = [];

function createWords() {
    var longP = mnemonic.generate(strength);
    var longSplitP = longP.split(" ");
    var shortSplitP = longSplitP.map(function(word) {
        var start = word.substring(0,4)
        while (start.length < 4) {
            start = start + "_";
        }
        return start;
    });
    var endingsP = longSplitP.map(function(word){
        var end = word.substring(4)
        return end
    })
    var counts = {};
    doubles.forEach(function(d) {
        counts[d]=0;
    })
    shortSplitP.forEach(function(w) {
        w.split("").forEach(function(l){
            counts[splitDoubles[l]] ++;
        })
    })
    return {longP: longSplitP, shortP: shortSplitP, counts:counts, endingsP:endingsP};
}

function evaluateEnough(words, counts) {
    var notenough = [];
    Object.keys(words.counts).forEach(function(d) {
        if (words.counts[d] > counts[d]) {
            notenough.push(d);
        }
    });
    words.notenough = notenough;
}

function evaluateAll() {
    console.log("evalueate all");
    if (countsLegal()) {
        var countObject = getCountObject();
        allWords.forEach(function(w){
            evaluateEnough(w, countObject);
        });
    }
}

function repaintWords() {
    if (countsLegal()) {
        var countObject = getCountObject();
        $("#passphrases").html("");
        var good = 0;
        html = "";
        allWords.reverse();
        allWords.forEach(function(o){
            html += "<hr>"
            for (var i=0; i<24; i++) {
                sh = o.shortP[i];
                en = o.endingsP[i];
                html += sh;
                html += "<font color='gray'><small>"+en+"</small></font> ";
            }
            if (o.notenough.length == 0) {
                good ++;
                html+="<br><font color='green'>Enough letters!</font>";
            } else {
                html+="<br><font color='red'>Not enough: ";
                o.notenough.forEach(function(d) {
                    html += d;
                    html += " ( ";
                    html += o.counts[d];
                    html += " in seed, only ";
                    html += countObject[d];
                    html += " in cards ); ";
                });
                html += "</font>";
            }
        })
        $("#gensofar").text(allWords.length);
        $("#covered").text(good);
        $("#perc").text(100*good/allWords.length);
        allWords.reverse();
        $("#passphrases").html(html);
    }
}

function createAndEvaluate() {
    for (var i = 0; i < 20; i++) {
        allWords.push(createWords());
    }
    evaluateAll();
    repaintWords();
}

$(document).ready( function() {
    $("button").bind("click",  createAndEvaluate);
});

</script>
</head>

<body>
<br>
<div class="container">

<div class="row">
  <div class="col-md-12">

<form class="form-horizontal" id="json-form">
<div class="form-group">
<label class="col-sm-2 control-label" for="json">json/python obj</label>
 <div class="col-sm-10">
<input type="text" class="form-control" id="json"></div>

</div>
<div class="form-group">

<label class="col-sm-2 control-label" for="link">link</label>
 <div class="col-sm-10" id="link">
</div></div>

</form>
</div>
<div class="col-md-2">
<form class="form-horizontal" id="letter-form">



<div class="form-group">
<label class="col-sm-6 control-label" for="count1">A/E</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count1"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count2">R/O</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count2"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count3">I/S</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count3"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count4">T/N</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count4"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count5">L/C</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count5"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count6">U/P</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count6"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count7">D/M</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count7"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count8">B/G</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count8"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count9">H/F</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count9"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count10">W/V</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count10"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count11">K/Y</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count11"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count12">X/J</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count12"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count13">Z/Q</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count13"></div></div>
<div class="form-group">
<label class="col-sm-6 control-label" for="count14">space</label>
 <div class="col-sm-6">
<input type="text" class="form-control" id="count14"></div></div>
  <!--button type="submit" class="btn btn-default">Do something</button-->
</form>

</div>
<div class="col-md-10">
  <button type="submit" class="btn btn-default">Generate more seeds</button>
  Generated so far: <span id="gensofar">0</span>, covered: <span id="covered">0</span> = <span id="perc">NA</span> %, total cards: <span id="totcards"></span>

<div id="passphrases">
<hr>
(nothing here so far)
</div>

</div>

</div></div>
</body>
</html>
